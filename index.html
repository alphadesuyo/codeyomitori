<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚ªãƒªã‚¸ãƒŠãƒ«ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Š</title>
<style>
body { 
    font-family:sans-serif; 
    text-align:center; 
    margin:20px; 
    background-color: #f0f0f0;
}
video { 
    border:2px solid #333; 
    max-width:90%; 
    height:auto; 
    border-radius: 8px;
    background-color: #000;
}
#result {
    background-color: white;
    padding: 10px;
    border-radius: 5px;
    margin: 10px auto;
    max-width: 500px;
    border: 1px solid #ddd;
}
button {
    padding: 10px 20px;
    font-size: 16px;
    margin: 10px;
    border: none;
    border-radius: 5px;
    background-color: #007bff;
    color: white;
    cursor: pointer;
}
button:hover {
    background-color: #0056b3;
}
.status {
    margin: 10px 0;
    padding: 5px;
    border-radius: 3px;
}
.error { background-color: #ffebee; color: #c62828; }
.success { background-color: #e8f5e8; color: #2e7d32; }
.warning { background-color: #fff3e0; color: #ef6c00; }
</style>
</head>
<body>
<h2>ã‚«ãƒ¡ãƒ©ã§ã‚³ãƒ¼ãƒ‰è‡ªå‹•èª­ã¿å–ã‚Š</h2>
<button id="startBtn">ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
<button id="switchBtn" style="display:none;">ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ</button>

<video id="video" autoplay playsinline muted style="display:none;"></video>
<p id="status" class="status">ã‚«ãƒ¡ãƒ©é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
<p id="result">å¾…æ©Ÿä¸­...</p>
<canvas id="canvas" width="600" height="400" style="display:none;"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const result = document.getElementById('result');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');

const BLOCK_W = 50, BLOCK_H = 50;
let currentStream = null;
let useFrontCamera = false;
let isDecoding = false;

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºé–¢æ•°
function showStatus(message, type = 'warning') {
    status.innerHTML = message;
    status.className = 'status ' + type;
}

// ã‚«ãƒ¡ãƒ©é–‹å§‹é–¢æ•°
async function startCamera() {
    try {
        // æ—¢å­˜ã®ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }

        showStatus('ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...', 'warning');

        // ã‚«ãƒ¡ãƒ©åˆ¶ç´„
        const constraints = {
            video: {
                facingMode: useFrontCamera ? "user" : "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ¶ç´„ï¼ˆfacingModeãŒä½¿ãˆãªã„å ´åˆï¼‰
        const fallbackConstraints = {
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        let stream;
        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (err) {
            console.log('facingModeã§ã®å–å¾—ã«å¤±æ•—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’è©¦è¡Œ:', err);
            stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
        }

        currentStream = stream;
        video.srcObject = stream;
        
        // ãƒ“ãƒ‡ã‚ªã®æº–å‚™å®Œäº†ã‚’å¾…ã¤
        video.onloadedmetadata = () => {
            video.play().then(() => {
                showStatus('ã‚«ãƒ¡ãƒ©èµ·å‹•æˆåŠŸï¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ãã ã•ã„', 'success');
                video.style.display = 'block';
                startBtn.style.display = 'none';
                switchBtn.style.display = 'inline-block';
                startDecoding();
            }).catch(err => {
                console.error('ãƒ“ãƒ‡ã‚ªå†ç”Ÿã‚¨ãƒ©ãƒ¼:', err);
                showStatus('ãƒ“ãƒ‡ã‚ªã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message, 'error');
            });
        };

    } catch (err) {
        console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
        let errorMessage = 'ã‚«ãƒ¡ãƒ©ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸ: ';
        
        if (err.name === 'NotAllowedError') {
            errorMessage += 'ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
        } else if (err.name === 'NotFoundError') {
            errorMessage += 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
        } else if (err.name === 'NotSupportedError') {
            errorMessage += 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚';
        } else if (err.name === 'NotReadableError') {
            errorMessage += 'ã‚«ãƒ¡ãƒ©ãŒä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ä¸­ã§ã™ã€‚';
        } else {
            errorMessage += err.message;
        }
        
        showStatus(errorMessage, 'error');
    }
}

// ã‚«ãƒ¡ãƒ©åˆ‡ã‚Šæ›¿ãˆ
function switchCamera() {
    useFrontCamera = !useFrontCamera;
    showStatus('ã‚«ãƒ¡ãƒ©ã‚’åˆ‡ã‚Šæ›¿ãˆä¸­...', 'warning');
    startCamera();
}

// æ”¹è‰¯ã•ã‚ŒãŸè‰²åˆ¤å®šï¼ˆHSVè‰²ç©ºé–“ã‚‚è€ƒæ…®ï¼‰
function colorToChar(r,g,b){
    // RGBå€¤ã®æ­£è¦åŒ–
    const total = r + g + b;
    if(total < 50) return ''; // é»’ã™ãã‚‹å ´åˆã¯ç„¡è¦–
    
    const rRatio = r / Math.max(total, 1);
    const gRatio = g / Math.max(total, 1);
    const bRatio = b / Math.max(total, 1);
    
    // èµ¤ãŒå¼·ã„ï¼ˆå¤§æ–‡å­—ï¼‰
    if(rRatio > 0.45 && r > 80 && r > g * 1.3 && r > b * 1.3) {
        return 'A';
    }
    // é’ãŒå¼·ã„ï¼ˆå°æ–‡å­—ï¼‰
    if(bRatio > 0.45 && b > 80 && b > r * 1.3 && b > g * 1.3) {
        return 'a';
    }
    // ç·‘ãŒå¼·ã„ï¼ˆæ•°å­—ï¼‰
    if(gRatio > 0.45 && g > 80 && g > r * 1.3 && g > b * 1.3) {
        return '0';
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šçµ¶å¯¾å€¤ã§ã®åˆ¤å®š
    if(r > 150 && g < 100 && b < 100) return 'A';
    if(b > 150 && r < 100 && g < 100) return 'a';
    if(g > 150 && r < 100 && b < 100) return '0';
    
    return '';
}

// ãƒ‡ã‚³ãƒ¼ãƒ‰é–‹å§‹
function startDecoding() {
    decodeFrame();
}

// æ”¹è‰¯ã•ã‚ŒãŸãƒ•ãƒ¬ãƒ¼ãƒ è§£æ
function decodeFrame(){
    if(video.readyState === video.HAVE_ENOUGH_DATA && !video.paused){
        try {
            // ãƒ“ãƒ‡ã‚ªã®å®Ÿéš›ã®ã‚µã‚¤ã‚ºã‚’å–å¾—
            const videoWidth = video.videoWidth || video.width;
            const videoHeight = video.videoHeight || video.height;
            
            if(videoWidth === 0 || videoHeight === 0) {
                requestAnimationFrame(decodeFrame);
                return;
            }
            
            // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’å‹•çš„ã«èª¿æ•´
            const aspectRatio = videoWidth / videoHeight;
            let canvasWidth = 600;
            let canvasHeight = Math.floor(canvasWidth / aspectRatio);
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // ãƒ“ãƒ‡ã‚ªã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
            ctx.drawImage(video, 0, 0, canvasWidth, canvasHeight);
            const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
            const data = imageData.data;
            
            // ã‚°ãƒªãƒƒãƒ‰ã‚µã‚¤ã‚ºã‚’å‹•çš„è¨ˆç®—
            const gridCols = 6; // ç”Ÿæˆå´ã¨åˆã‚ã›ã‚‹
            const gridRows = 3;
            const cellWidth = Math.floor(canvasWidth / gridCols);
            const cellHeight = Math.floor(canvasHeight / gridRows);
            
            let detectedCode = '';
            let detectionConfidence = [];
            
            for(let row = 0; row < gridRows; row++){
                for(let col = 0; col < gridCols; col++){
                    let rSum = 0, gSum = 0, bSum = 0, count = 0;
                    
                    // ã‚»ãƒ«ã®ä¸­å¤®éƒ¨åˆ†ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆãƒã‚¤ã‚ºã‚’æ¸›ã‚‰ã™ãŸã‚ï¼‰
                    const startX = col * cellWidth + Math.floor(cellWidth * 0.2);
                    const endX = col * cellWidth + Math.floor(cellWidth * 0.8);
                    const startY = row * cellHeight + Math.floor(cellHeight * 0.2);
                    const endY = row * cellHeight + Math.floor(cellHeight * 0.8);
                    
                    for(let y = startY; y < endY; y++){
                        for(let x = startX; x < endX; x++){
                            if(x < canvasWidth && y < canvasHeight){
                                const idx = (y * canvasWidth + x) * 4;
                                rSum += data[idx];
                                gSum += data[idx + 1];
                                bSum += data[idx + 2];
                                count++;
                            }
                        }
                    }
                    
                    if(count > 0) {
                        const avgR = Math.floor(rSum / count);
                        const avgG = Math.floor(gSum / count);
                        const avgB = Math.floor(bSum / count);
                        
                        const char = colorToChar(avgR, avgG, avgB);
                        detectedCode += char;
                        
                        // æ¤œå‡ºå“è³ªã‚’ãƒã‚§ãƒƒã‚¯
                        const brightness = (avgR + avgG + avgB) / 3;
                        const colorStrength = Math.max(avgR, avgG, avgB) - Math.min(avgR, avgG, avgB);
                        detectionConfidence.push({
                            char, brightness, colorStrength,
                            rgb: `R:${avgR} G:${avgG} B:${avgB}`
                        });
                    }
                }
            }
            
            // ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
            const validChars = detectedCode.replace(/[^A-Za-z0-9]/g, '');
            const detectionQuality = detectionConfidence.filter(d => d.char !== '').length;
            
            if(validChars.length >= 10){
                // å®Œå…¨ãªã‚³ãƒ¼ãƒ‰ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆ
                result.innerHTML = `
                    <div style="color: green; font-weight: bold;">âœ… ã‚³ãƒ¼ãƒ‰æ¤œå‡ºæˆåŠŸ!</div>
                    <div>ã‚³ãƒ¼ãƒ‰ID: <strong>${validChars}</strong></div>
                    <div>ã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›ä¸­...</div>
                    <div style="font-size: 12px; color: #666;">æ¤œå‡ºå“è³ª: ${detectionQuality}/18</div>
                `;
                
                // APIå‘¼ã³å‡ºã—
                fetch('https://collectors-hb-hampshire-rush.trycloudflare.com/api/get/' + validChars)
                .then(res => {
                    if (!res.ok) {
                        throw new Error('HTTP ' + res.status);
                    }
                    return res.json();
                })
                .then(data => {
                    result.innerHTML = `
                        <div style="color: green; font-weight: bold;">ğŸ“‹ ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ!</div>
                        <div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: left;">
                            <strong>å†…å®¹:</strong><br>
                            ${data.text || 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'}
                        </div>
                        <div style="font-size: 12px; color: #666;">ã‚³ãƒ¼ãƒ‰ID: ${validChars}</div>
                    `;
                })
                .catch(err => {
                    result.innerHTML = `
                        <div style="color: orange;">âš ï¸ ãƒ‡ãƒ¼ã‚¿å–å¾—å¤±æ•—</div>
                        <div>ã‚¨ãƒ©ãƒ¼: ${err.message}</div>
                        <div>æ¤œå‡ºã—ãŸã‚³ãƒ¼ãƒ‰: ${validChars}</div>
                    `;
                });
            } else if(validChars.length > 0) {
                // éƒ¨åˆ†çš„ã«æ¤œå‡ºã•ã‚ŒãŸå ´åˆ
                result.innerHTML = `
                    <div style="color: blue;">ğŸ” ã‚³ãƒ¼ãƒ‰è§£æä¸­...</div>
                    <div>æ¤œå‡º: "${validChars}" (${validChars.length}/10æ–‡å­—)</div>
                    <div style="font-size: 12px; color: #666;">
                        å“è³ª: ${detectionQuality}/18 | 
                        ç”Ÿãƒ‡ãƒ¼ã‚¿: "${detectedCode}"
                    </div>
                    <div style="font-size: 11px; color: #999;">
                        ã‚«ãƒ¡ãƒ©ã‚’ã‚³ãƒ¼ãƒ‰ã«è¿‘ã¥ã‘ã¦ã€ç…§æ˜ã‚’èª¿æ•´ã—ã¦ãã ã•ã„
                    </div>
                `;
            } else {
                // ä½•ã‚‚æ¤œå‡ºã•ã‚Œãªã„å ´åˆ
                result.innerHTML = `
                    <div style="color: #666;">ğŸ‘ï¸ ã‚³ãƒ¼ãƒ‰ã‚’æ¢ã—ã¦ã„ã¾ã™...</div>
                    <div style="font-size: 12px;">
                        ã‚³ãƒ¼ãƒ‰ã‚’ã‚«ãƒ¡ãƒ©ã®ä¸­å¤®ã«é…ç½®ã—ã¦ãã ã•ã„
                    </div>
                `;
            }
            
        } catch (err) {
            console.error('ãƒ‡ã‚³ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', err);
            result.innerHTML = `<div style="color: red;">ã‚¨ãƒ©ãƒ¼: ${err.message}</div>`;
        }
    }
    
    // ç¶™ç¶šã—ã¦ãƒ•ãƒ¬ãƒ¼ãƒ è§£æ
    requestAnimationFrame(decodeFrame);
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
startBtn.addEventListener('click', startCamera);
switchBtn.addEventListener('click', switchCamera);

// ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
window.addEventListener('beforeunload', () => {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
    }
});

// MediaDevicesãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showStatus('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã€Firefoxã€Safariç­‰ã®æœ€æ–°ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠä½¿ã„ãã ã•ã„ã€‚', 'error');
    startBtn.style.display = 'none';
} else {
    showStatus('ã‚«ãƒ¡ãƒ©é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„', 'warning');
}
</script>
</body>
</html>
