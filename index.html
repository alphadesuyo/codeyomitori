<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ”¹è‰¯ç‰ˆã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã‚·ã‚¹ãƒ†ãƒ </title>
<style>
* { box-sizing: border-box; }

body { 
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

.container {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}

h1 {
    text-align: center;
    margin: 0 0 30px 0;
    color: #4a5568;
    font-size: 2.2em;
    font-weight: 300;
}

video { 
    width: 100%;
    max-width: 400px;
    border: 3px solid #333; 
    border-radius: 15px;
    background: #000;
    display: block;
    margin: 0 auto;
}

button {
    display: block;
    margin: 15px auto;
    padding: 12px 24px;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    min-width: 150px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.btn-capture {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    font-size: 18px;
    padding: 15px 30px;
}

.btn-capture:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.status {
    text-align: center;
    margin: 15px 0;
    padding: 15px;
    border-radius: 10px;
    font-weight: 500;
}

.status.success { background: #f0fff4; color: #22543d; border: 2px solid #68d391; }
.status.error { background: #fed7d7; color: #c53030; border: 2px solid #fc8181; }
.status.warning { background: #fefcbf; color: #b7791f; border: 2px solid #f6e05e; }
.status.info { background: #ebf8ff; color: #2c5282; border: 2px solid #90cdf4; }

#result {
    background: #f8fafc;
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    border-left: 5px solid #667eea;
    text-align: left;
}

.analysis-section {
    margin: 20px 0;
    padding: 20px;
    background: #f7fafc;
    border-radius: 15px;
    border: 1px solid #e2e8f0;
}

.grid-display {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    margin: 15px 0;
    justify-items: center;
}

.cell-info {
    text-align: center;
    font-size: 12px;
    padding: 8px 4px;
    border-radius: 8px;
    border: 2px solid #2d3748;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.detection-details {
    margin: 15px 0;
    padding: 15px;
    background: white;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}

@media(max-width: 480px) {
    .container { margin: 10px; padding: 20px; }
    h1 { font-size: 1.8em; }
    .grid-display { grid-template-columns: repeat(3, 1fr); }
}
</style>
</head>
<body>
<div class="container">
    <h1>ğŸ“¸ ã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã‚·ã‚¹ãƒ†ãƒ </h1>
    
    <button id="startBtn" class="btn-primary">ğŸ“¹ ã‚«ãƒ¡ãƒ©é–‹å§‹</button>
    
    <video id="video" autoplay playsinline muted style="display:none;"></video>
    
    <button id="captureBtn" class="btn-capture" style="display:none;">ğŸ“¸ å†™çœŸã‚’æ’®ã£ã¦è§£æ</button>
    
    <div id="status" class="status info">ã‚«ãƒ¡ãƒ©é–‹å§‹ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</div>
    
    <div id="analysisSection" class="analysis-section" style="display:none;">
        <h3>ğŸ” è§£æçµæœ</h3>
        <div id="gridDisplay" class="grid-display"></div>
        <div id="detectionDetails" class="detection-details"></div>
    </div>
    
    <div id="result">å¾…æ©Ÿä¸­...</div>
    
    <canvas id="canvas" style="display:none;"></canvas>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const result = document.getElementById('result');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const captureBtn = document.getElementById('captureBtn');
const analysisSection = document.getElementById('analysisSection');
const gridDisplay = document.getElementById('gridDisplay');
const detectionDetails = document.getElementById('detectionDetails');

let currentStream = null;

// æ­£ã—ã„æ–‡å­—ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ†ãƒ¼ãƒ–ãƒ«
const colorToCharMap = {
    'red': ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'],
    'blue': ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'],
    'green': ['0','1','2','3','4','5','6','7','8','9']
};

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
function showStatus(message, type = 'info') {
    status.innerHTML = message;
    status.className = 'status ' + type;
}

// ã‚«ãƒ¡ãƒ©é–‹å§‹
async function startCamera() {
    try {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }

        showStatus('ğŸ“¹ ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...', 'info');

        const constraints = {
            video: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        let stream;
        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (err) {
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: { ideal: 1280 }, height: { ideal: 720 } } 
            });
        }

        currentStream = stream;
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            video.play().then(() => {
                showStatus('âœ… ã‚«ãƒ¡ãƒ©èµ·å‹•å®Œäº†ï¼ã‚³ãƒ¼ãƒ‰ã‚’ç”»é¢ã«æ˜ ã—ã¦ãã ã•ã„', 'success');
                video.style.display = 'block';
                captureBtn.style.display = 'block';
                startBtn.style.display = 'none';
            }).catch(err => {
                showStatus('âŒ ãƒ“ãƒ‡ã‚ªå†ç”Ÿã‚¨ãƒ©ãƒ¼: ' + err.message, 'error');
            });
        };

    } catch (err) {
        console.error('ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼:', err);
        showStatus('âŒ ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹å¤±æ•—: ' + err.message, 'error');
    }
}

// å†™çœŸæ’®å½±ã¨è§£æ
function captureAndAnalyze() {
    if (video.readyState !== video.HAVE_ENOUGH_DATA) {
        showStatus('âš ï¸ ã‚«ãƒ¡ãƒ©ã®æº–å‚™ä¸­ã§ã™...', 'warning');
        return;
    }

    showStatus('ğŸ“¸ å†™çœŸæ’®å½±ãƒ»è§£æä¸­...', 'info');
    captureBtn.disabled = true;

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚µã‚¤ã‚ºã‚’è¨­å®š
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    
    // ãƒ“ãƒ‡ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // è§£æå®Ÿè¡Œ
    setTimeout(() => {
        analyzeImage();
        captureBtn.disabled = false;
    }, 500);
}

// ç”»åƒè§£æï¼ˆå®Œå…¨ã«æ›¸ãç›´ã—ï¼‰
function analyzeImage() {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    // 6x3ã‚°ãƒªãƒƒãƒ‰ã§è§£æ
    const gridCols = 6;
    const gridRows = 3;
    const cellWidth = Math.floor(canvas.width / gridCols);
    const cellHeight = Math.floor(canvas.height / gridRows);

    let detectedChars = [];
    let gridHTML = '';
    let detailsHTML = '<h4>è©³ç´°è§£æãƒ‡ãƒ¼ã‚¿:</h4>';

    for (let row = 0; row < gridRows; row++) {
        for (let col = 0; col < gridCols; col++) {
            const cellIndex = row * gridCols + col;
            const cellResult = analyzeCellAdvanced(data, canvas.width, canvas.height, col, row, cellWidth, cellHeight, cellIndex);
            
            detectedChars.push(cellResult.detectedChar);

            // ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤ºç”¨HTML
            gridHTML += `
                <div class="cell-info" style="background-color: ${cellResult.dominantColorHex};">
                    <div style="font-size: 16px; margin-bottom: 4px;">${cellResult.detectedChar || '?'}</div>
                    <div style="font-size: 10px;">${cellResult.colorName}</div>
                    <div style="font-size: 9px;">${cellResult.confidence.toFixed(1)}%</div>
                </div>
            `;

            // è©³ç´°æƒ…å ±
            detailsHTML += `
                <div style="margin: 8px 0; padding: 8px; background: #f0f0f0; border-radius: 6px;">
                    <strong>ã‚»ãƒ«${cellIndex + 1}:</strong> 
                    æ–‡å­—="<span style="color: ${cellResult.dominantColorHex}; font-weight: bold;">${cellResult.detectedChar || 'æœªæ¤œå‡º'}</span>"
                    | è‰²=${cellResult.colorName}
                    | RGB(${cellResult.avgR}, ${cellResult.avgG}, ${cellResult.avgB})
                    | ä¿¡é ¼åº¦=${cellResult.confidence.toFixed(1)}%
                </div>
            `;
        }
    }

    // çµæœè¡¨ç¤º
    gridDisplay.innerHTML = gridHTML;
    detectionDetails.innerHTML = detailsHTML;
    analysisSection.style.display = 'block';

    // ã‚³ãƒ¼ãƒ‰IDã‚’æ§‹ç¯‰
    const fullCodeId = detectedChars.join('');
    const validChars = fullCodeId.replace(/[^A-Za-z0-9]/g, '');
    const detectionRate = (detectedChars.filter(c => c && c !== '').length / 18 * 100).toFixed(1);

    showStatus(`ğŸ” è§£æå®Œäº† (æ¤œå‡ºç‡: ${detectionRate}%)`, detectionRate >= 80 ? 'success' : 'warning');

    if (validChars.length >= 10) {
        fetchDataFromServer(validChars, fullCodeId, detectionRate);
    } else {
        result.innerHTML = `
            <h3>âŒ èª­ã¿å–ã‚Šå¤±æ•—</h3>
            <p><strong>æ¤œå‡ºã•ã‚ŒãŸæ–‡å­—:</strong> "${fullCodeId}"</p>
            <p><strong>æœ‰åŠ¹æ–‡å­—æ•°:</strong> ${validChars.length}/10</p>
            <p><strong>æ¤œå‡ºç‡:</strong> ${detectionRate}%</p>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4>ğŸ’¡ æ”¹å–„æ–¹æ³•:</h4>
                <ul style="text-align: left; margin: 0;">
                    <li>ã‚³ãƒ¼ãƒ‰ã‚’ç”»é¢ã®ä¸­å¤®ã«é…ç½®ã™ã‚‹</li>
                    <li>ååˆ†ãªæ˜ã‚‹ã•ã‚’ç¢ºä¿ã™ã‚‹</li>
                    <li>ã‚«ãƒ¡ãƒ©ã¨ã‚³ãƒ¼ãƒ‰ã®è·é›¢ã‚’èª¿æ•´ã™ã‚‹</li>
                    <li>æ‰‹ãƒ–ãƒ¬ã‚’é¿ã‘ã¦å®‰å®šã•ã›ã‚‹</li>
                </ul>
            </div>
        `;
    }
}

// ã‚»ãƒ«è§£æï¼ˆå¤§å¹…æ”¹å–„ï¼‰
function analyzeCellAdvanced(data, canvasWidth, canvasHeight, col, row, cellWidth, cellHeight, cellIndex) {
    // ã‚»ãƒ«ã®ä¸­å¤®70%ã‚’ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°ï¼ˆãƒã‚¤ã‚ºé™¤å»ï¼‰
    const centerRatio = 0.35; // ä¸­å¤®70%
    const startX = Math.floor(col * cellWidth + cellWidth * centerRatio);
    const endX = Math.floor(col * cellWidth + cellWidth * (1 - centerRatio));
    const startY = Math.floor(row * cellHeight + cellHeight * centerRatio);
    const endY = Math.floor(row * cellHeight + cellHeight * (1 - centerRatio));

    let rSum = 0, gSum = 0, bSum = 0, count = 0;

    // ãƒ”ã‚¯ã‚»ãƒ«ãƒ‡ãƒ¼ã‚¿åé›†
    for (let y = startY; y < endY && y < canvasHeight; y++) {
        for (let x = startX; x < endX && x < canvasWidth; x++) {
            const idx = (y * canvasWidth + x) * 4;
            rSum += data[idx];
            gSum += data[idx + 1];
            bSum += data[idx + 2];
            count++;
        }
    }

    if (count === 0) {
        return {
            detectedChar: '',
            colorName: 'unknown',
            dominantColorHex: '#999999',
            confidence: 0,
            avgR: 0, avgG: 0, avgB: 0
        };
    }

    const avgR = Math.round(rSum / count);
    const avgG = Math.round(gSum / count);
    const avgB = Math.round(bSum / count);

    // è‰²åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆå¤§å¹…æ”¹å–„ï¼‰
    const colorAnalysis = analyzeColorAdvanced(avgR, avgG, avgB);
    
    // å®Ÿéš›ã®æ–‡å­—ã‚’å–å¾—ï¼ˆä½ç½®ãƒ™ãƒ¼ã‚¹ï¼‰
    let detectedChar = '';
    if (colorAnalysis.confidence > 30) { // æœ€å°ä¿¡é ¼åº¦ã—ãã„å€¤
        const charArray = colorToCharMap[colorAnalysis.colorName];
        if (charArray && cellIndex < charArray.length) {
            detectedChar = charArray[cellIndex % charArray.length];
        }
    }

    return {
        detectedChar,
        colorName: colorAnalysis.colorName,
        dominantColorHex: colorAnalysis.colorHex,
        confidence: colorAnalysis.confidence,
        avgR, avgG, avgB
    };
}

// è‰²è§£æï¼ˆé«˜ç²¾åº¦åŒ–ï¼‰
function analyzeColorAdvanced(r, g, b) {
    // æ˜åº¦ãƒã‚§ãƒƒã‚¯
    const brightness = (r + g + b) / 3;
    if (brightness < 40) {
        return { colorName: 'too_dark', colorHex: '#333333', confidence: 0 };
    }

    // å½©åº¦ã¨è‰²ç›¸ã®è¨ˆç®—
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    const delta = max - min;
    
    if (delta < 30) { // å½©åº¦ãŒä½ã™ãã‚‹
        return { colorName: 'gray', colorHex: '#888888', confidence: 0 };
    }

    // ç›¸å¯¾çš„ãªè‰²å¼·åº¦
    const total = r + g + b;
    const rRatio = r / total;
    const gRatio = g / total;
    const bRatio = b / total;

    let colorName = 'unknown';
    let confidence = 0;
    let colorHex = '#999999';

    // ã—ãã„å€¤ã‚’èª¿æ•´ï¼ˆã‚ˆã‚Šå³å¯†ã«ï¼‰
    const threshold = 0.4; // 40%ä»¥ä¸Šã§åˆ¤å®š

    if (rRatio > threshold && r > g && r > b) {
        colorName = 'red';
        colorHex = '#FF0000';
        confidence = ((rRatio - 1/3) * 3) * 100; // 0-100%
    } else if (bRatio > threshold && b > r && b > g) {
        colorName = 'blue';
        colorHex = '#0000FF';
        confidence = ((bRatio - 1/3) * 3) * 100;
    } else if (gRatio > threshold && g > r && g > b) {
        colorName = 'green';
        colorHex = '#00AA00';
        confidence = ((gRatio - 1/3) * 3) * 100;
    }

    return {
        colorName,
        colorHex,
        confidence: Math.min(100, Math.max(0, confidence))
    };
}

// ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
async function fetchDataFromServer(codeId, fullCodeId, detectionRate) {
    try {
        showStatus('ğŸŒ ã‚µãƒ¼ãƒãƒ¼ã«å•ã„åˆã‚ã›ä¸­...', 'info');
        
        const response = await fetch(`https://collectors-hb-hampshire-rush.trycloudflare.com/api/get/${codeId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        result.innerHTML = `
            <h3>âœ… èª­ã¿å–ã‚ŠæˆåŠŸï¼</h3>
            <div style="background: #e6fffa; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 5px solid #38b2ac;">
                <h4>ğŸ“„ ä¿å­˜ã•ã‚Œã¦ã„ãŸå†…å®¹:</h4>
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #bee3f8; font-size: 16px;">
                    ${data.text || 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ'}
                </div>
            </div>
            <div style="font-size: 14px; color: #666; margin-top: 15px;">
                <p><strong>ğŸ†” ã‚³ãƒ¼ãƒ‰ID:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">${codeId}</code></p>
                <p><strong>ğŸ“Š æ¤œå‡ºç‡:</strong> ${detectionRate}%</p>
                <p><strong>ğŸ” ç”Ÿãƒ‡ãƒ¼ã‚¿:</strong> "${fullCodeId}"</p>
            </div>
        `;

        showStatus('ğŸ‰ èª­ã¿å–ã‚Šãƒ»ãƒ‡ãƒ¼ã‚¿å–å¾—å®Œäº†ï¼', 'success');

    } catch (error) {
        console.error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
        result.innerHTML = `
            <h3>âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼</h3>
            <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
            <p><strong>æ¤œå‡ºã—ãŸã‚³ãƒ¼ãƒ‰:</strong> <code>${codeId}</code></p>
            <p>ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å•é¡ŒãŒã‚ã‚‹ã‹ã€å­˜åœ¨ã—ãªã„ã‚³ãƒ¼ãƒ‰ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
        `;
        showStatus(`âŒ ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
    }
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
startBtn.addEventListener('click', startCamera);
captureBtn.addEventListener('click', captureAndAnalyze);

// ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†
window.addEventListener('beforeunload', () => {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
    }
});

// åˆæœŸåŒ–
if (!navigator.mediaDevices?.getUserMedia) {
    showStatus('âŒ ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“', 'error');
    startBtn.style.display = 'none';
}
</script>
</body>
</html>
