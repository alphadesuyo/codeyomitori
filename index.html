<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>オリジナルコード読み取り</title>
<style>
body { 
    font-family:sans-serif; 
    text-align:center; 
    margin:20px; 
    background-color: #f0f0f0;
}
video { 
    border:2px solid #333; 
    max-width:90%; 
    height:auto; 
    border-radius: 8px;
    background-color: #000;
}
#result {
    background-color: white;
    padding: 10px;
    border-radius: 5px;
    margin: 10px auto;
    max-width: 500px;
    border: 1px solid #ddd;
}
button {
    padding: 10px 20px;
    font-size: 16px;
    margin: 10px;
    border: none;
    border-radius: 5px;
    background-color: #007bff;
    color: white;
    cursor: pointer;
}
button:hover {
    background-color: #0056b3;
}
.status {
    margin: 10px 0;
    padding: 5px;
    border-radius: 3px;
}
.error { background-color: #ffebee; color: #c62828; }
.success { background-color: #e8f5e8; color: #2e7d32; }
.warning { background-color: #fff3e0; color: #ef6c00; }
</style>
</head>
<body>
<h2>カメラでコード自動読み取り</h2>
<button id="startBtn">カメラを開始</button>
<button id="switchBtn" style="display:none;">カメラ切り替え</button>

<video id="video" autoplay playsinline muted style="display:none;"></video>
<p id="status" class="status">カメラ開始ボタンを押してください</p>
<p id="result">待機中...</p>
<canvas id="canvas" width="600" height="400" style="display:none;"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const result = document.getElementById('result');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const switchBtn = document.getElementById('switchBtn');

const BLOCK_W = 50, BLOCK_H = 50;
let currentStream = null;
let useFrontCamera = false;
let isDecoding = false;

// ステータス表示関数
function showStatus(message, type = 'warning') {
    status.innerHTML = message;
    status.className = 'status ' + type;
}

// カメラ開始関数
async function startCamera() {
    try {
        // 既存のストリームを停止
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }

        showStatus('カメラにアクセス中...', 'warning');

        // カメラ制約
        const constraints = {
            video: {
                facingMode: useFrontCamera ? "user" : "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        // フォールバック制約（facingModeが使えない場合）
        const fallbackConstraints = {
            video: {
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        let stream;
        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (err) {
            console.log('facingModeでの取得に失敗、フォールバックを試行:', err);
            stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
        }

        currentStream = stream;
        video.srcObject = stream;
        
        // ビデオの準備完了を待つ
        video.onloadedmetadata = () => {
            video.play().then(() => {
                showStatus('カメラ起動成功！コードをカメラに向けてください', 'success');
                video.style.display = 'block';
                startBtn.style.display = 'none';
                switchBtn.style.display = 'inline-block';
                startDecoding();
            }).catch(err => {
                console.error('ビデオ再生エラー:', err);
                showStatus('ビデオの再生に失敗しました: ' + err.message, 'error');
            });
        };

    } catch (err) {
        console.error('カメラエラー:', err);
        let errorMessage = 'カメラを開けませんでした: ';
        
        if (err.name === 'NotAllowedError') {
            errorMessage += 'カメラへのアクセスが拒否されました。ブラウザの設定を確認してください。';
        } else if (err.name === 'NotFoundError') {
            errorMessage += 'カメラが見つかりません。';
        } else if (err.name === 'NotSupportedError') {
            errorMessage += 'このブラウザはカメラをサポートしていません。';
        } else if (err.name === 'NotReadableError') {
            errorMessage += 'カメラが他のアプリケーションで使用中です。';
        } else {
            errorMessage += err.message;
        }
        
        showStatus(errorMessage, 'error');
    }
}

// カメラ切り替え
function switchCamera() {
    useFrontCamera = !useFrontCamera;
    showStatus('カメラを切り替え中...', 'warning');
    startCamera();
}

// 改良された色判定（HSV色空間も考慮）
function colorToChar(r,g,b){
    // RGB値の正規化
    const total = r + g + b;
    if(total < 50) return ''; // 黒すぎる場合は無視
    
    const rRatio = r / Math.max(total, 1);
    const gRatio = g / Math.max(total, 1);
    const bRatio = b / Math.max(total, 1);
    
    // 赤が強い（大文字）
    if(rRatio > 0.45 && r > 80 && r > g * 1.3 && r > b * 1.3) {
        return 'A';
    }
    // 青が強い（小文字）
    if(bRatio > 0.45 && b > 80 && b > r * 1.3 && b > g * 1.3) {
        return 'a';
    }
    // 緑が強い（数字）
    if(gRatio > 0.45 && g > 80 && g > r * 1.3 && g > b * 1.3) {
        return '0';
    }
    
    // フォールバック：絶対値での判定
    if(r > 150 && g < 100 && b < 100) return 'A';
    if(b > 150 && r < 100 && g < 100) return 'a';
    if(g > 150 && r < 100 && b < 100) return '0';
    
    return '';
}

// デコード開始
function startDecoding() {
    decodeFrame();
}

// 改良されたフレーム解析
function decodeFrame(){
    if(video.readyState === video.HAVE_ENOUGH_DATA && !video.paused){
        try {
            // ビデオの実際のサイズを取得
            const videoWidth = video.videoWidth || video.width;
            const videoHeight = video.videoHeight || video.height;
            
            if(videoWidth === 0 || videoHeight === 0) {
                requestAnimationFrame(decodeFrame);
                return;
            }
            
            // キャンバスサイズを動的に調整
            const aspectRatio = videoWidth / videoHeight;
            let canvasWidth = 600;
            let canvasHeight = Math.floor(canvasWidth / aspectRatio);
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // ビデオをキャンバスに描画
            ctx.drawImage(video, 0, 0, canvasWidth, canvasHeight);
            const imageData = ctx.getImageData(0, 0, canvasWidth, canvasHeight);
            const data = imageData.data;
            
            // グリッドサイズを動的計算
            const gridCols = 6; // 生成側と合わせる
            const gridRows = 3;
            const cellWidth = Math.floor(canvasWidth / gridCols);
            const cellHeight = Math.floor(canvasHeight / gridRows);
            
            let detectedCode = '';
            let detectionConfidence = [];
            
            for(let row = 0; row < gridRows; row++){
                for(let col = 0; col < gridCols; col++){
                    let rSum = 0, gSum = 0, bSum = 0, count = 0;
                    
                    // セルの中央部分をサンプリング（ノイズを減らすため）
                    const startX = col * cellWidth + Math.floor(cellWidth * 0.2);
                    const endX = col * cellWidth + Math.floor(cellWidth * 0.8);
                    const startY = row * cellHeight + Math.floor(cellHeight * 0.2);
                    const endY = row * cellHeight + Math.floor(cellHeight * 0.8);
                    
                    for(let y = startY; y < endY; y++){
                        for(let x = startX; x < endX; x++){
                            if(x < canvasWidth && y < canvasHeight){
                                const idx = (y * canvasWidth + x) * 4;
                                rSum += data[idx];
                                gSum += data[idx + 1];
                                bSum += data[idx + 2];
                                count++;
                            }
                        }
                    }
                    
                    if(count > 0) {
                        const avgR = Math.floor(rSum / count);
                        const avgG = Math.floor(gSum / count);
                        const avgB = Math.floor(bSum / count);
                        
                        const char = colorToChar(avgR, avgG, avgB);
                        detectedCode += char;
                        
                        // 検出品質をチェック
                        const brightness = (avgR + avgG + avgB) / 3;
                        const colorStrength = Math.max(avgR, avgG, avgB) - Math.min(avgR, avgG, avgB);
                        detectionConfidence.push({
                            char, brightness, colorStrength,
                            rgb: `R:${avgR} G:${avgG} B:${avgB}`
                        });
                    }
                }
            }
            
            // デバッグ情報を表示
            const validChars = detectedCode.replace(/[^A-Za-z0-9]/g, '');
            const detectionQuality = detectionConfidence.filter(d => d.char !== '').length;
            
            if(validChars.length >= 10){
                // 完全なコードが検出された場合
                result.innerHTML = `
                    <div style="color: green; font-weight: bold;">✅ コード検出成功!</div>
                    <div>コードID: <strong>${validChars}</strong></div>
                    <div>サーバーに問い合わせ中...</div>
                    <div style="font-size: 12px; color: #666;">検出品質: ${detectionQuality}/18</div>
                `;
                
                // API呼び出し
                fetch('https://collectors-hb-hampshire-rush.trycloudflare.com/api/get/' + validChars)
                .then(res => {
                    if (!res.ok) {
                        throw new Error('HTTP ' + res.status);
                    }
                    return res.json();
                })
                .then(data => {
                    result.innerHTML = `
                        <div style="color: green; font-weight: bold;">📋 データ取得成功!</div>
                        <div style="background: #f0f8ff; padding: 10px; border-radius: 5px; margin: 10px 0; text-align: left;">
                            <strong>内容:</strong><br>
                            ${data.text || 'データが見つかりませんでした'}
                        </div>
                        <div style="font-size: 12px; color: #666;">コードID: ${validChars}</div>
                    `;
                })
                .catch(err => {
                    result.innerHTML = `
                        <div style="color: orange;">⚠️ データ取得失敗</div>
                        <div>エラー: ${err.message}</div>
                        <div>検出したコード: ${validChars}</div>
                    `;
                });
            } else if(validChars.length > 0) {
                // 部分的に検出された場合
                result.innerHTML = `
                    <div style="color: blue;">🔍 コード解析中...</div>
                    <div>検出: "${validChars}" (${validChars.length}/10文字)</div>
                    <div style="font-size: 12px; color: #666;">
                        品質: ${detectionQuality}/18 | 
                        生データ: "${detectedCode}"
                    </div>
                    <div style="font-size: 11px; color: #999;">
                        カメラをコードに近づけて、照明を調整してください
                    </div>
                `;
            } else {
                // 何も検出されない場合
                result.innerHTML = `
                    <div style="color: #666;">👁️ コードを探しています...</div>
                    <div style="font-size: 12px;">
                        コードをカメラの中央に配置してください
                    </div>
                `;
            }
            
        } catch (err) {
            console.error('デコードエラー:', err);
            result.innerHTML = `<div style="color: red;">エラー: ${err.message}</div>`;
        }
    }
    
    // 継続してフレーム解析
    requestAnimationFrame(decodeFrame);
}

// イベントリスナー
startBtn.addEventListener('click', startCamera);
switchBtn.addEventListener('click', switchCamera);

// ページ離脱時にカメラを停止
window.addEventListener('beforeunload', () => {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
    }
});

// MediaDevicesがサポートされているかチェック
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    showStatus('このブラウザはカメラをサポートしていません。Chrome、Firefox、Safari等の最新ブラウザをお使いください。', 'error');
    startBtn.style.display = 'none';
} else {
    showStatus('カメラ開始ボタンを押してください', 'warning');
}
</script>
</body>
</html>
