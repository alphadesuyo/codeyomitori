<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>改良版コード読み取りシステム</title>
<style>
* { box-sizing: border-box; }

body { 
    font-family: 'Segoe UI', sans-serif;
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    color: #333;
}

.container {
    max-width: 600px;
    margin: 0 auto;
    background: white;
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
}

h1 {
    text-align: center;
    margin: 0 0 30px 0;
    color: #4a5568;
    font-size: 2.2em;
    font-weight: 300;
}

video { 
    width: 100%;
    max-width: 400px;
    border: 3px solid #333; 
    border-radius: 15px;
    background: #000;
    display: block;
    margin: 0 auto;
}

button {
    display: block;
    margin: 15px auto;
    padding: 12px 24px;
    font-size: 16px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 600;
    min-width: 150px;
}

.btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.btn-primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
}

.btn-capture {
    background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
    color: white;
    font-size: 18px;
    padding: 15px 30px;
}

.btn-capture:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

.status {
    text-align: center;
    margin: 15px 0;
    padding: 15px;
    border-radius: 10px;
    font-weight: 500;
}

.status.success { background: #f0fff4; color: #22543d; border: 2px solid #68d391; }
.status.error { background: #fed7d7; color: #c53030; border: 2px solid #fc8181; }
.status.warning { background: #fefcbf; color: #b7791f; border: 2px solid #f6e05e; }
.status.info { background: #ebf8ff; color: #2c5282; border: 2px solid #90cdf4; }

#result {
    background: #f8fafc;
    padding: 20px;
    border-radius: 15px;
    margin: 20px 0;
    border-left: 5px solid #667eea;
    text-align: left;
}

.analysis-section {
    margin: 20px 0;
    padding: 20px;
    background: #f7fafc;
    border-radius: 15px;
    border: 1px solid #e2e8f0;
}

.grid-display {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 8px;
    margin: 15px 0;
    justify-items: center;
}

.cell-info {
    text-align: center;
    font-size: 12px;
    padding: 8px 4px;
    border-radius: 8px;
    border: 2px solid #2d3748;
    min-height: 60px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    color: white;
    font-weight: bold;
}

.detection-details {
    margin: 15px 0;
    padding: 15px;
    background: white;
    border-radius: 10px;
    border: 1px solid #e2e8f0;
}

@media(max-width: 480px) {
    .container { margin: 10px; padding: 20px; }
    h1 { font-size: 1.8em; }
    .grid-display { grid-template-columns: repeat(3, 1fr); }
}
</style>
</head>
<body>
<div class="container">
    <h1>📸 コード読み取りシステム</h1>
    
    <button id="startBtn" class="btn-primary">📹 カメラ開始</button>
    
    <video id="video" autoplay playsinline muted style="display:none;"></video>
    
    <button id="captureBtn" class="btn-capture" style="display:none;">📸 写真を撮って解析</button>
    
    <div id="status" class="status info">カメラ開始ボタンを押してください</div>
    
    <div id="analysisSection" class="analysis-section" style="display:none;">
        <h3>🔍 解析結果</h3>
        <div id="gridDisplay" class="grid-display"></div>
        <div id="detectionDetails" class="detection-details"></div>
    </div>
    
    <div id="result">待機中...</div>
    
    <canvas id="canvas" style="display:none;"></canvas>
</div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const result = document.getElementById('result');
const status = document.getElementById('status');
const startBtn = document.getElementById('startBtn');
const captureBtn = document.getElementById('captureBtn');
const analysisSection = document.getElementById('analysisSection');
const gridDisplay = document.getElementById('gridDisplay');
const detectionDetails = document.getElementById('detectionDetails');

let currentStream = null;

// 正しい文字マッピングテーブル
const colorToCharMap = {
    'red': ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'],
    'blue': ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z'],
    'green': ['0','1','2','3','4','5','6','7','8','9']
};

// ステータス表示
function showStatus(message, type = 'info') {
    status.innerHTML = message;
    status.className = 'status ' + type;
}

// カメラ開始
async function startCamera() {
    try {
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }

        showStatus('📹 カメラにアクセス中...', 'info');

        const constraints = {
            video: {
                facingMode: "environment",
                width: { ideal: 1280 },
                height: { ideal: 720 }
            }
        };

        let stream;
        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (err) {
            // フォールバック
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { width: { ideal: 1280 }, height: { ideal: 720 } } 
            });
        }

        currentStream = stream;
        video.srcObject = stream;
        
        video.onloadedmetadata = () => {
            video.play().then(() => {
                showStatus('✅ カメラ起動完了！コードを画面に映してください', 'success');
                video.style.display = 'block';
                captureBtn.style.display = 'block';
                startBtn.style.display = 'none';
            }).catch(err => {
                showStatus('❌ ビデオ再生エラー: ' + err.message, 'error');
            });
        };

    } catch (err) {
        console.error('カメラエラー:', err);
        showStatus('❌ カメラアクセス失敗: ' + err.message, 'error');
    }
}

// 写真撮影と解析
function captureAndAnalyze() {
    if (video.readyState !== video.HAVE_ENOUGH_DATA) {
        showStatus('⚠️ カメラの準備中です...', 'warning');
        return;
    }

    showStatus('📸 写真撮影・解析中...', 'info');
    captureBtn.disabled = true;

    // キャンバスサイズを設定
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    
    // ビデオフレームをキャプチャ
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // 解析実行
    setTimeout(() => {
        analyzeImage();
        captureBtn.disabled = false;
    }, 500);
}

// 画像解析（完全に書き直し）
function analyzeImage() {
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = imageData.data;

    // 6x3グリッドで解析
    const gridCols = 6;
    const gridRows = 3;
    const cellWidth = Math.floor(canvas.width / gridCols);
    const cellHeight = Math.floor(canvas.height / gridRows);

    let detectedChars = [];
    let gridHTML = '';
    let detailsHTML = '<h4>詳細解析データ:</h4>';

    for (let row = 0; row < gridRows; row++) {
        for (let col = 0; col < gridCols; col++) {
            const cellIndex = row * gridCols + col;
            const cellResult = analyzeCellAdvanced(data, canvas.width, canvas.height, col, row, cellWidth, cellHeight, cellIndex);
            
            detectedChars.push(cellResult.detectedChar);

            // グリッド表示用HTML
            gridHTML += `
                <div class="cell-info" style="background-color: ${cellResult.dominantColorHex};">
                    <div style="font-size: 16px; margin-bottom: 4px;">${cellResult.detectedChar || '?'}</div>
                    <div style="font-size: 10px;">${cellResult.colorName}</div>
                    <div style="font-size: 9px;">${cellResult.confidence.toFixed(1)}%</div>
                </div>
            `;

            // 詳細情報
            detailsHTML += `
                <div style="margin: 8px 0; padding: 8px; background: #f0f0f0; border-radius: 6px;">
                    <strong>セル${cellIndex + 1}:</strong> 
                    文字="<span style="color: ${cellResult.dominantColorHex}; font-weight: bold;">${cellResult.detectedChar || '未検出'}</span>"
                    | 色=${cellResult.colorName}
                    | RGB(${cellResult.avgR}, ${cellResult.avgG}, ${cellResult.avgB})
                    | 信頼度=${cellResult.confidence.toFixed(1)}%
                </div>
            `;
        }
    }

    // 結果表示
    gridDisplay.innerHTML = gridHTML;
    detectionDetails.innerHTML = detailsHTML;
    analysisSection.style.display = 'block';

    // コードIDを構築
    const fullCodeId = detectedChars.join('');
    const validChars = fullCodeId.replace(/[^A-Za-z0-9]/g, '');
    const detectionRate = (detectedChars.filter(c => c && c !== '').length / 18 * 100).toFixed(1);

    showStatus(`🔍 解析完了 (検出率: ${detectionRate}%)`, detectionRate >= 80 ? 'success' : 'warning');

    if (validChars.length >= 10) {
        fetchDataFromServer(validChars, fullCodeId, detectionRate);
    } else {
        result.innerHTML = `
            <h3>❌ 読み取り失敗</h3>
            <p><strong>検出された文字:</strong> "${fullCodeId}"</p>
            <p><strong>有効文字数:</strong> ${validChars.length}/10</p>
            <p><strong>検出率:</strong> ${detectionRate}%</p>
            <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h4>💡 改善方法:</h4>
                <ul style="text-align: left; margin: 0;">
                    <li>コードを画面の中央に配置する</li>
                    <li>十分な明るさを確保する</li>
                    <li>カメラとコードの距離を調整する</li>
                    <li>手ブレを避けて安定させる</li>
                </ul>
            </div>
        `;
    }
}

// セル解析（大幅改善）
function analyzeCellAdvanced(data, canvasWidth, canvasHeight, col, row, cellWidth, cellHeight, cellIndex) {
    // セルの中央70%をサンプリング（ノイズ除去）
    const centerRatio = 0.35; // 中央70%
    const startX = Math.floor(col * cellWidth + cellWidth * centerRatio);
    const endX = Math.floor(col * cellWidth + cellWidth * (1 - centerRatio));
    const startY = Math.floor(row * cellHeight + cellHeight * centerRatio);
    const endY = Math.floor(row * cellHeight + cellHeight * (1 - centerRatio));

    let rSum = 0, gSum = 0, bSum = 0, count = 0;

    // ピクセルデータ収集
    for (let y = startY; y < endY && y < canvasHeight; y++) {
        for (let x = startX; x < endX && x < canvasWidth; x++) {
            const idx = (y * canvasWidth + x) * 4;
            rSum += data[idx];
            gSum += data[idx + 1];
            bSum += data[idx + 2];
            count++;
        }
    }

    if (count === 0) {
        return {
            detectedChar: '',
            colorName: 'unknown',
            dominantColorHex: '#999999',
            confidence: 0,
            avgR: 0, avgG: 0, avgB: 0
        };
    }

    const avgR = Math.round(rSum / count);
    const avgG = Math.round(gSum / count);
    const avgB = Math.round(bSum / count);

    // 色判定ロジック（大幅改善）
    const colorAnalysis = analyzeColorAdvanced(avgR, avgG, avgB);
    
    // 実際の文字を取得（位置ベース）
    let detectedChar = '';
    if (colorAnalysis.confidence > 30) { // 最小信頼度しきい値
        const charArray = colorToCharMap[colorAnalysis.colorName];
        if (charArray && cellIndex < charArray.length) {
            detectedChar = charArray[cellIndex % charArray.length];
        }
    }

    return {
        detectedChar,
        colorName: colorAnalysis.colorName,
        dominantColorHex: colorAnalysis.colorHex,
        confidence: colorAnalysis.confidence,
        avgR, avgG, avgB
    };
}

// 色解析（高精度化）
function analyzeColorAdvanced(r, g, b) {
    // 明度チェック
    const brightness = (r + g + b) / 3;
    if (brightness < 40) {
        return { colorName: 'too_dark', colorHex: '#333333', confidence: 0 };
    }

    // 彩度と色相の計算
    const max = Math.max(r, g, b);
    const min = Math.min(r, g, b);
    const delta = max - min;
    
    if (delta < 30) { // 彩度が低すぎる
        return { colorName: 'gray', colorHex: '#888888', confidence: 0 };
    }

    // 相対的な色強度
    const total = r + g + b;
    const rRatio = r / total;
    const gRatio = g / total;
    const bRatio = b / total;

    let colorName = 'unknown';
    let confidence = 0;
    let colorHex = '#999999';

    // しきい値を調整（より厳密に）
    const threshold = 0.4; // 40%以上で判定

    if (rRatio > threshold && r > g && r > b) {
        colorName = 'red';
        colorHex = '#FF0000';
        confidence = ((rRatio - 1/3) * 3) * 100; // 0-100%
    } else if (bRatio > threshold && b > r && b > g) {
        colorName = 'blue';
        colorHex = '#0000FF';
        confidence = ((bRatio - 1/3) * 3) * 100;
    } else if (gRatio > threshold && g > r && g > b) {
        colorName = 'green';
        colorHex = '#00AA00';
        confidence = ((gRatio - 1/3) * 3) * 100;
    }

    return {
        colorName,
        colorHex,
        confidence: Math.min(100, Math.max(0, confidence))
    };
}

// サーバーからデータ取得
async function fetchDataFromServer(codeId, fullCodeId, detectionRate) {
    try {
        showStatus('🌐 サーバーに問い合わせ中...', 'info');
        
        const response = await fetch(`https://collectors-hb-hampshire-rush.trycloudflare.com/api/get/${codeId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        
        result.innerHTML = `
            <h3>✅ 読み取り成功！</h3>
            <div style="background: #e6fffa; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 5px solid #38b2ac;">
                <h4>📄 保存されていた内容:</h4>
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #bee3f8; font-size: 16px;">
                    ${data.text || 'データが見つかりませんでした'}
                </div>
            </div>
            <div style="font-size: 14px; color: #666; margin-top: 15px;">
                <p><strong>🆔 コードID:</strong> <code style="background: #f0f0f0; padding: 2px 6px; border-radius: 4px;">${codeId}</code></p>
                <p><strong>📊 検出率:</strong> ${detectionRate}%</p>
                <p><strong>🔍 生データ:</strong> "${fullCodeId}"</p>
            </div>
        `;

        showStatus('🎉 読み取り・データ取得完了！', 'success');

    } catch (error) {
        console.error('サーバーエラー:', error);
        result.innerHTML = `
            <h3>❌ サーバーエラー</h3>
            <p><strong>エラー:</strong> ${error.message}</p>
            <p><strong>検出したコード:</strong> <code>${codeId}</code></p>
            <p>サーバーとの通信に問題があるか、存在しないコードの可能性があります。</p>
        `;
        showStatus(`❌ サーバーエラー: ${error.message}`, 'error');
    }
}

// イベントリスナー
startBtn.addEventListener('click', startCamera);
captureBtn.addEventListener('click', captureAndAnalyze);

// リソース管理
window.addEventListener('beforeunload', () => {
    if (currentStream) {
        currentStream.getTracks().forEach(track => track.stop());
    }
});

// 初期化
if (!navigator.mediaDevices?.getUserMedia) {
    showStatus('❌ このブラウザはカメラをサポートしていません', 'error');
    startBtn.style.display = 'none';
}
</script>
</body>
</html>
