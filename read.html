<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>オリジナルコード読み取り</title>
<style>
body { font-family:sans-serif; text-align:center; margin:20px; }
video { border:1px solid #000; }
@media(max-width:480px){
    video { width: 90%; height:auto; }
}
</style>
</head>
<body>
<h2>カメラでコード自動読み取り</h2>
<video id="video" width="300" height="120" autoplay playsinline></video>
<p id="result">解析中...</p>
<canvas id="canvas" width="300" height="120" style="display:none;"></canvas>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const result = document.getElementById('result');
const BLOCK_W = 50, BLOCK_H = 50;

// カメラ起動
navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment" } // 背面カメラ優先
})
.then(stream=>{
    video.srcObject = stream;
    return video.play().catch(err => console.error("再生失敗:", err));
})
.catch(err=>{
    console.error("カメラ起動エラー:", err);
    result.innerText = "カメラが使えません: " + err.message;
});

// 色から文字判定
function colorToChar(r,g,b){
    if(r>150 && g<100 && b<100) return 'A'; //大文字
    if(b>150 && r<100 && g<100) return 'a'; //小文字
    if(g>150 && r<100 && b<100) return '0'; //数字
    return '';
}

// フレーム解析
function decodeFrame(){
    if(video.readyState === video.HAVE_ENOUGH_DATA){
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const img = ctx.getImageData(0,0,canvas.width,canvas.height).data;
        let code_id='';
        for(let by=0;by<2;by++){
            for(let bx=0;bx<5;bx++){
                let rSum=0,gSum=0,bSum=0,count=0;
                for(let y=Math.floor(by*BLOCK_H);y<Math.floor((by+1)*BLOCK_H);y++){
                    for(let x=Math.floor(bx*BLOCK_W);x<Math.floor((bx+1)*BLOCK_W);x++){
                        const idx=(y*canvas.width + x)*4;
                        rSum+=img[idx]; gSum+=img[idx+1]; bSum+=img[idx+2]; count++;
                    }
                }
                rSum=Math.floor(rSum/count);
                gSum=Math.floor(gSum/count);
                bSum=Math.floor(bSum/count);
                const c=colorToChar(rSum,gSum,bSum);
                code_id += c;
            }
        }

        if(code_id){
            fetch('https://collectors-hb-hampshire-rush.trycloudflare.com/api/get/'+code_id)
            .then(res=>res.json())
            .then(data=>result.innerText='読み取ったデータ:\n'+data.text)
            .catch(()=>result.innerText='データ取得失敗');
        }
    }
    requestAnimationFrame(decodeFrame);
}

decodeFrame();
</script>
</body>
</html>
